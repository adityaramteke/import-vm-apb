FROM ansibleplaybookbundle/apb-base

LABEL "com.redhat.apb.spec"=\
"dmVyc2lvbjogMS4wCm5hbWU6IGltcG9ydC12bS1hcGIKZGVzY3JpcHRpb246IEltcG9ydCBWaXJ0\
dWFsIE1hY2hpbmUKYmluZGFibGU6IEZhbHNlCmFzeW5jOiBvcHRpb25hbAp0YWdzOgogIC0gdmly\
dHVhbG1hY2hpbmUKbWV0YWRhdGE6CiAgZGlzcGxheU5hbWU6IEltcG9ydCBWaXJ0dWFsIE1hY2hp\
bmUKICBpbWFnZVVybDogaHR0cHM6Ly9jZG4ucGJyZC5jby9pbWFnZXMvSDVHdXRkNy5wbmcKICBs\
b25nRGVzY3JpcHRpb246IHwKICAgICBJbXBvcnQgVmlydHVhbCBNYWNoaW5lIGZyb20gYW4gZXhp\
c3RpbmcgaW1hZ2Ugb3IgYSBWTXdhcmUgZW52aXJvbm1lbnQuCnBsYW5zOgogIC0gbmFtZTogdm13\
YXJlCiAgICBkZXNjcmlwdGlvbjogSW1wb3J0IGEgdmlydHVhbCBtYWNoaW5lIGZyb20gVk13YXJl\
IHZDZW50ZXIuCiAgICBmcmVlOiBUcnVlCiAgICBtZXRhZGF0YToKICAgICAgZGlzcGxheU5hbWU6\
IGMuIEltcG9ydCBmcm9tIFZNd2FyZS4KICAgIHBhcmFtZXRlcnM6CiAgICAgIC0gdGl0bGU6IE9w\
ZW5TaGlmdCBBZG1pbiBVc2VybmFtZQogICAgICAgIG5hbWU6IGFkbWluX3VzZXIKICAgICAgICB0\
eXBlOiBzdHJpbmcKICAgICAgICByZXF1aXJlZDogdHJ1ZQogICAgICAtIHRpdGxlOiBPcGVuU2hp\
ZnQgQWRtaW4gUGFzc3dvcmQKICAgICAgICBuYW1lOiBhZG1pbl9wYXNzd29yZAogICAgICAgIHR5\
cGU6IHN0cmluZwogICAgICAgIHJlcXVpcmVkOiB0cnVlCiAgICAgICAgZGlzcGxheV90eXBlOiBw\
YXNzd29yZAogICAgICAtIHRpdGxlOiBWTXdhcmUgVVJMIHRvIEVYU2kKICAgICAgICBuYW1lOiB1\
cmwKICAgICAgICB0eXBlOiBzdHJpbmcKICAgICAgICByZXF1aXJlZDogdHJ1ZQogICAgICAtIHRp\
dGxlOiBWaXJ0dWFsIE1hY2hpbmUgTmFtZQogICAgICAgIG5hbWU6IHZtX25hbWUKICAgICAgICB0\
eXBlOiBzdHJpbmcKICAgICAgICByZXF1aXJlZDogdHJ1ZQogICAgICAtIHRpdGxlOiBWTXdhcmUg\
QWRtaW4gVXNlcm5hbWUKICAgICAgICBuYW1lOiB1c2VybmFtZQogICAgICAgIHR5cGU6IHN0cmlu\
ZwogICAgICAgIHJlcXVpcmVkOiB0cnVlCiAgICAgICAgZGlzcGxheV90eXBlOiB1c2VybmFtZQog\
ICAgICAtIHRpdGxlOiBWTXdhcmUgQWRtaW4gUGFzc3dvcmQKICAgICAgICBuYW1lOiBwYXNzd29y\
ZAogICAgICAgIHR5cGU6IHN0cmluZwogICAgICAgIHJlcXVpcmVkOiB0cnVlCiAgICAgICAgZGlz\
cGxheV90eXBlOiBwYXNzd29yZAogICAgICAtIHRpdGxlOiBPcGVyYXRpbmcgU3lzdGVtIFR5cGUK\
ICAgICAgICBuYW1lOiBvc190eXBlCiAgICAgICAgZGVmYXVsdDogbGludXgKICAgICAgICBlbnVt\
OiBbJ2xpbnV4JywgJ3dpbmRvd3MnXQogICAgICAgIHR5cGU6IGVudW0KICAtIG5hbWU6IHZtd2Fy\
ZS10ZW1wbGF0ZQogICAgZGVzY3JpcHRpb246IEltcG9ydCBhIHZpcnR1YWwgbWFjaGluZSBhcyBh\
IHRlbXBsYXRlIGZyb20gVk13YXJlIHZDZW50ZXIuCiAgICBmcmVlOiBUcnVlCiAgICBtZXRhZGF0\
YToKICAgICAgZGlzcGxheU5hbWU6IGQuIEltcG9ydCBhcyBhIHRlbXBsYXRlIGZyb20gVk13YXJl\
LgogICAgcGFyYW1ldGVyczoKICAgICAgLSB0aXRsZTogT3BlblNoaWZ0IEFkbWluIFVzZXJuYW1l\
CiAgICAgICAgbmFtZTogYWRtaW5fdXNlcgogICAgICAgIHR5cGU6IHN0cmluZwogICAgICAgIHJl\
cXVpcmVkOiB0cnVlCiAgICAgIC0gdGl0bGU6IE9wZW5TaGlmdCBBZG1pbiBQYXNzd29yZAogICAg\
ICAgIG5hbWU6IGFkbWluX3Bhc3N3b3JkCiAgICAgICAgdHlwZTogc3RyaW5nCiAgICAgICAgcmVx\
dWlyZWQ6IHRydWUKICAgICAgICBkaXNwbGF5X3R5cGU6IHBhc3N3b3JkCiAgICAgIC0gdGl0bGU6\
IFZNd2FyZSBVUkwgdG8gRVhTaQogICAgICAgIG5hbWU6IHVybAogICAgICAgIHR5cGU6IHN0cmlu\
ZwogICAgICAgIHJlcXVpcmVkOiB0cnVlCiAgICAgIC0gdGl0bGU6IFRlbXBsYXRlIE5hbWUKICAg\
ICAgICBuYW1lOiB2bV9uYW1lCiAgICAgICAgdHlwZTogc3RyaW5nCiAgICAgICAgcmVxdWlyZWQ6\
IHRydWUKICAgICAgLSB0aXRsZTogVk13YXJlIEFkbWluIFVzZXJuYW1lCiAgICAgICAgbmFtZTog\
dXNlcm5hbWUKICAgICAgICB0eXBlOiBzdHJpbmcKICAgICAgICByZXF1aXJlZDogdHJ1ZQogICAg\
ICAgIGRpc3BsYXlfdHlwZTogdXNlcm5hbWUKICAgICAgLSB0aXRsZTogVk13YXJlIEFkbWluIFBh\
c3N3b3JkCiAgICAgICAgbmFtZTogcGFzc3dvcmQKICAgICAgICB0eXBlOiBzdHJpbmcKICAgICAg\
ICByZXF1aXJlZDogdHJ1ZQogICAgICAgIGRpc3BsYXlfdHlwZTogcGFzc3dvcmQKICAgICAgLSB0\
aXRsZTogT3BlcmF0aW5nIFN5c3RlbSBUeXBlCiAgICAgICAgbmFtZTogb3NfdHlwZQogICAgICAg\
IGRlZmF1bHQ6IGxpbnV4CiAgICAgICAgZW51bTogWydsaW51eCcsICd3aW5kb3dzJ10KICAgICAg\
ICB0eXBlOiBlbnVtCiAgLSBuYW1lOiB1cmwKICAgIGRlc2NyaXB0aW9uOiBDcmVhdGUgYSB2aXJ0\
dWFsIG1hY2hpbmUgZnJvbSBhIGRvd25sb2FkZWQgZGlzayBpbWFnZS4KICAgIGZyZWU6IFRydWUK\
ICAgIG1ldGFkYXRhOgogICAgICBkaXNwbGF5TmFtZTogYS4gSW1wb3J0IGZyb20gVVJMLgogICAg\
cGFyYW1ldGVyczoKICAgICAgLSB0aXRsZTogRGlzayBJbWFnZSBVUkwKICAgICAgICBuYW1lOiBk\
aXNrX2ltYWdlX3VybAogICAgICAgIHR5cGU6IHN0cmluZwogICAgICAgIHJlcXVpcmVkOiB0cnVl\
CiAgICAgIC0gdGl0bGU6IE9wZXJhdGluZyBzeXN0ZW0gdHlwZQogICAgICAgIG5hbWU6IG9zX3R5\
cGUKICAgICAgICBkZWZhdWx0OiBsaW51eAogICAgICAgIGVudW06IFsnbGludXgnLCAnd2luZG93\
cyddCiAgICAgICAgdHlwZTogZW51bQogICAgICAtIHRpdGxlOiBWaXJ0dWFsIE1hY2hpbmUgTmFt\
ZQogICAgICAgIG5hbWU6IHZtX25hbWUKICAgICAgICB0eXBlOiBzdHJpbmcKICAgICAgICByZXF1\
aXJlZDogdHJ1ZQogICAgICAtIHRpdGxlOiBOdW1iZXIgb2YgQ29yZXMKICAgICAgICBuYW1lOiBu\
cl9jb3JlcwogICAgICAgIHJlcXVpcmVkOiB0cnVlCiAgICAgICAgdHlwZTogaW50CiAgICAgICAg\
ZGVmYXVsdDogMQogICAgICAtIHRpdGxlOiBNZW1vcnkgKE1pQikKICAgICAgICBuYW1lOiBtZW0K\
ICAgICAgICByZXF1aXJlZDogdHJ1ZQogICAgICAgIHR5cGU6IGludAogICAgICAgIGRlZmF1bHQ6\
IDEwMjQKICAgICAgLSB0aXRsZTogRGlzayBTaXplIChHaUIpIChsZWF2ZSBhdCAwIHRvIGF1dG8g\
ZGV0ZWN0IHNpemUpCiAgICAgICAgbmFtZTogZGlza19zaXplX2diCiAgICAgICAgdHlwZTogaW50\
CiAgICAgICAgZGVmYXVsdDogMAogICAgICAtIHRpdGxlOiBTdG9yYWdlIENsYXNzIChsZWF2ZSBl\
bXB0eSB0byB1c2UgdGhlIGRlZmF1bHQgc3RvcmFnZSBjbGFzcykKICAgICAgICBuYW1lOiBzdG9y\
YWdlX2NsYXNzCiAgICAgICAgdHlwZTogc3RyaW5nCiAgLSBuYW1lOiB1cmwtdGVtcGxhdGUKICAg\
IGRlc2NyaXB0aW9uOiBDcmVhdGUgYSB2aXJ0dWFsIG1hY2hpbmUgdGVtcGxhdGUgZnJvbSBhIGRv\
d25sb2FkZWQgZGlzayBpbWFnZS4KICAgIGZyZWU6IFRydWUKICAgIG1ldGFkYXRhOgogICAgICBk\
aXNwbGF5TmFtZTogYi4gSW1wb3J0IGFzIGEgdGVtcGxhdGUgZnJvbSBVUkwuCiAgICBwYXJhbWV0\
ZXJzOgogICAgICAtIHRpdGxlOiBPcGVuU2hpZnQgQWRtaW4gVXNlcm5hbWUKICAgICAgICBuYW1l\
OiBhZG1pbl91c2VyCiAgICAgICAgdHlwZTogc3RyaW5nCiAgICAgICAgcmVxdWlyZWQ6IHRydWUK\
ICAgICAgLSB0aXRsZTogT3BlblNoaWZ0IEFkbWluIFBhc3N3b3JkCiAgICAgICAgbmFtZTogYWRt\
aW5fcGFzc3dvcmQKICAgICAgICB0eXBlOiBzdHJpbmcKICAgICAgICByZXF1aXJlZDogdHJ1ZQog\
ICAgICAgIGRpc3BsYXlfdHlwZTogcGFzc3dvcmQKICAgICAgLSB0aXRsZTogRGlzayBJbWFnZSBV\
UkwKICAgICAgICBuYW1lOiBkaXNrX2ltYWdlX3VybAogICAgICAgIHR5cGU6IHN0cmluZwogICAg\
ICAgIHJlcXVpcmVkOiB0cnVlCiAgICAgIC0gdGl0bGU6IE9wZXJhdGluZyBzeXN0ZW0gdHlwZQog\
ICAgICAgIG5hbWU6IG9zX3R5cGUKICAgICAgICBkZWZhdWx0OiBsaW51eAogICAgICAgIGVudW06\
IFsnbGludXgnLCAnd2luZG93cyddCiAgICAgICAgdHlwZTogZW51bQogICAgICAtIHRpdGxlOiBU\
ZW1wbGF0ZSBOYW1lCiAgICAgICAgbmFtZTogdm1fbmFtZQogICAgICAgIHR5cGU6IHN0cmluZwog\
ICAgICAgIHJlcXVpcmVkOiB0cnVlCiAgICAgIC0gdGl0bGU6IE51bWJlciBvZiBDb3JlcwogICAg\
ICAgIG5hbWU6IG5yX2NvcmVzCiAgICAgICAgcmVxdWlyZWQ6IHRydWUKICAgICAgICB0eXBlOiBp\
bnQKICAgICAgICBkZWZhdWx0OiAxCiAgICAgIC0gdGl0bGU6IE1lbW9yeSAoTWlCKQogICAgICAg\
IG5hbWU6IG1lbQogICAgICAgIHJlcXVpcmVkOiB0cnVlCiAgICAgICAgdHlwZTogaW50CiAgICAg\
ICAgZGVmYXVsdDogMTAyNAogICAgICAtIHRpdGxlOiBEaXNrIFNpemUgKEdpQikgKGxlYXZlIGF0\
IDAgdG8gYXV0byBkZXRlY3Qgc2l6ZSkKICAgICAgICBuYW1lOiBkaXNrX3NpemVfZ2IKICAgICAg\
ICB0eXBlOiBpbnQKICAgICAgICBkZWZhdWx0OiAwCiAgICAgIC0gdGl0bGU6IFN0b3JhZ2UgQ2xh\
c3MgKGxlYXZlIGVtcHR5IHRvIHVzZSB0aGUgZGVmYXVsdCBzdG9yYWdlIGNsYXNzKQogICAgICAg\
IG5hbWU6IHN0b3JhZ2VfY2xhc3MKICAgICAgICB0eXBlOiBzdHJpbmcK"



RUN chmod -R g=u /opt/{ansible,apb}
RUN yum -y install libvirt-client curl qemu-img wget && yum clean all
# We need this to get oc v3.9 due to the issue with oc apply. Once we would update apb-base to use 3.9 we can remove it
RUN wget https://github.com/openshift/origin/releases/download/v3.9.0/openshift-origin-client-tools-v3.9.0-191fece-linux-64bit.tar.gz
RUN tar zxvf openshift-origin-client-tools-v3.9.0-191fece-linux-64bit.tar.gz
RUN mv openshift-origin-client-tools-v3.9.0-191fece-linux-64bit/oc /usr/bin
RUN rm -rf openshift-origin-client-tools-v3.9.0-191fece-linux-64bit
RUN chmod u+x /usr/bin/oc
# future removal ends here
COPY bin/run-v2v.sh /v2v.d/
RUN setfacl -Rm u:apb:rwx /v2v.d

COPY playbooks /opt/apb/actions
COPY roles /opt/apb/actions/roles
COPY templates /opt/apb/actions/templates

USER apb
